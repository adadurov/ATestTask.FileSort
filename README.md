# СОРТИРОВКА СТРОЧЕК В БОЛЬШОМ ТЕКСТОВОМ ФАЙЛЕ

Данный репозиторий содержит исходные тексты программ, реализующих 2 утилиты командной строки:

* ATestTask.FileSort.Sort.CLI.exe -- сортировка строчек в текстовом файле
* ATestTask.FileSort.Create.CLI.exe -- подготовка текстовых данных заданного размера для сортировки

## СТЕК

* C# 9.0
* .NET 5.0

## СОРТИРОВКА СТРОЧЕК В ФАЙЛЕ - ATestTask.FileSort.Sort.CLI.exe

### СИНТАКСИС

ATestTask.FileSort.Sort.CLI.exe sort <file_name> [<degree_of_parallelism> [<chunk_size_in_megabytes>]]

file_name -- имя входного файла, содержимое которого должно быть отсортировано

mdegree_of_parallelism -- степень параллельности обработки; 0 -- создать по одному обработчику на ядро

chunk_size_in_megabytes -- приближенный размер каждого фрагмента

### ОПИСАНИЕ

Утилита сортирует входной файл, указанный в командной строке методом External Sort и сохраняет результат сортировки в новом файле.
Имя выходного файла -- <file_name>.sorted. Файл располагается в той же папке, в которой располагается входной файл.
Для временного хранения фрагментов используется временная папка, создаваемая в папке, содержащей входной файл. 
Имя папки формируется из случайного набора символов.

Каждая запись (строчка) входного файла должна стоятть из целого десятичного числа, разделителя ". " и произвольного текста, содержащего латинские символы и пробелы.
Детальные требования описаны в разделе ОГРАНИЧЕНИЯ ниже.

Если выходной файл уже существует, утилита не выполняет сортировку и прерывает работу с ненулевым кодом возврата.

В процессе работы утилита выводит в консоль информационные сообщения, а при наличии ошибок -- сообщения об ошибках.

#### ПОТРЕБЛЕНИЕ ПАМЯТИ

При параллельной обработке, каждый обработчик потребляет примерно 2.5xS байт RAM, где S -- размер фрагмента.
Например, при параллельной обработке 10 фрагментов размером 100 MiB, потребление памяти составит около 2.7 GiB.

#### ОГРАНИЧЕНИЯ

1. Входной файл должен быть в ASCII кодировке.
2. Разделитель строчек -- \n или \r\n
3. Символ возврата каретки ('\r'), если он присутствует в последовательности, разделяющей сточки во входном файле, сортируется как часть английского текста.  
За счет того, что его двоичным представлением является число 10, при сортировке короткие строчки корректно сравниваются с более длинными строчками, содержащими как строчные, так и прописные латинские символы.
4. Числа в начале строчек не должны содержать ведущих нулей (leading zeroes).

### ПРЕИМУЩЕСТВА

  1. Решение поддерживает числа произвольной длины (нет ограничений в 32, 64 бита и т.п.).

### ПУТИ ДАЛЬНЕЙШЕГО УЛУЧШЕНИЯ

#### СОКРАЩЕНИЕ ВРЕМЕНИ ВЫПОЛНЕНИЯ

1. Двойная буферизация при чтении фрагментов в процессе их объединения в выходной фал.  
Текущая реализация надеется, что ОС оптимильно выполняет упреждающее чтение (read ahead), что конечно не всегда верно.
2. Если файл маленьки, его можно отсортировать в памяти и сразу сохранить, не выполняя бессмысленного "объединения" одного фрагмента.
3. При параллельной обработке можно сразу объединять фрагменты и получать во временном хранилище фрагменты бОльшего размера.
4. Применить адаптивное многоэтапное объединение фрагментов.

#### КАЧЕСТВО КОДА

* Отмечу, что в коде есть места, где, что называется, "торчат кишки наружу".  
  Нужно сделать рефакторинг, чтобы такого не было, но при этом сохранилась бы возможность модульного тестирования.
* Есть возможности улучшить повторное использование кода между компонентами, выполняющими разбиение на фрагменты и объединение фрагментов.


## СОЗДАНИЕ ТЕСТОВЫХ ДАННЫХ - ATestTask.FileSort.Create.CLI.exe

### СИНТАКСИС

ATestTask.FileSort.Create.CLI.exe <file_name> <size_in_mebibytes>

### ПРИМЕРЫ

ATestTask.FileSort.Create.CLI.exe g100.txt 102400

Создать тестовый файл и записать в него не менее 100 GiB тестовых строчек (актуальный объем может превышать заданный размер на величину, не превышающую 1 MiB.

### СИСТЕМНЫЕ ТРЕБОВАНИЯ

* CPU: Intel x86-64 (другие архитектуры не тестировались) для x86 необходимо ограничить степень конкурентности обработки)
* RAM: ~10 MB per CPU core
* OS: Windows 10
* Сторонние компоненты: Microsoft .NET 5.0
